#!/bin/bash

#desc# CodeStream API service init script

function usage {
    echo "usage: $0 { start | stop | status | restart } [-f] [-- server-args]" >&2
    echo >&2
    echo "   -f  run in foreground"
    exit 1
}

[ -z "$CS_API_TOP" ] && echo "cs_api sandbox not loaded">&2 && exit 1
[[ ! ( "$1" == start || "$1" == stop || "$1" == status ) ]] && usage

. $DT_TOP/lib/init_funcs.sh

action=$1
run_fg=0
OPTIND=2
while getopts "f" arg
do
    case $arg in
        f) run_fg=1;;
        *) usage;;
    esac
done
shift `expr $OPTIND - 1`

ec=0
server_args=$*
case "$action" in
    start)
        if [ "$CS_API_SETUP_MONGO" == true ]; then
            if [ -n "$CS_API_MONGO_USER" -a ! -f $CS_API_SANDBOX/mongo-user.configured ]; then
                echo "Creating mongo user $CS_API_MONGO_USER as dbOwner of codestream db"
                mdb-add-user -u $CS_API_MONGO_USER -p $CS_API_MONGO_PASS -r dbOwner -D codestream
                touch $CS_API_SANDBOX/mongo-user.configured
            fi
            if [ ! -f $CS_API_SANDBOX/mongo-indexes.configured ]; then
                echo "Running ensure-indexes.js..."
                echo "touch $CS_API_SANDBOX/mongo-indexes.configured to prevent this on future starts."
                (cd $CS_API_TOP && bin/ensure-indexes.js)
            fi
        fi
        echo "Starting $CS_API_TOP/bin/api_server.js. Logging to $CS_API_LOG_DIRECTORY/api.log"
        if [ $run_fg -eq 1 ]; then
            $CS_API_TOP/bin/api_server.js $server_args
        else
            nohup $CS_API_TOP/bin/api_server.js $server_args >/dev/null 2>&1 </dev/null &
            sleep 1
            service_status $CS_API_TOP/bin/api_server.js
        fi
        ;;
    stop)
        service_stop $CS_API_TOP/bin/api_server.js
        ec=$?
        sleep 2
        service_status $CS_API_TOP/bin/api_server.js
        ;;
    status)
        service_status $CS_API_TOP/bin/api_server.js
        ;;
    *)
        usage
        ;;
esac
exit $ec
