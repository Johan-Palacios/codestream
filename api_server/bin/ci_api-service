#!/bin/bash

#desc# CIDER API service init script

function usage {
    echo "usage: $0 { start | stop | status } [-f] [-- server-args]" >&2
    echo >&2
    echo "   -f  run in foreground"
    exit 1
}

[ -z "$CI_API_TOP" ] && echo "ci_api sandbox not loaded">&2 && exit 1
[[ ! ( "$1" == start || "$1" == stop || "$1" == status ) ]] && usage

. $DT_TOP/lib/init_funcs.sh

action=$1
run_fg=0
OPTIND=2
while getopts "f" arg
do
  case $arg in
    f) run_fg=1;;
    *) usage;;
  esac
done
shift `expr $OPTIND - 1`

server_args=$*
case "$action" in
	start)
		echo "Starting $CI_API_TOP/bin/api_server.js. Logging to $CI_API_LOG_DIRECTORY/api.log"
		if [ $run_fg -eq 1 ]; then
			$CI_API_TOP/bin/api_server.js $server_args
		else
			nohup $CI_API_TOP/bin/api_server.js $server_args >/dev/null 2>&1 </dev/null &
			sleep 1
			service_status api_server.js
		fi
		;;
  stop)
		service_stop api_server.js
		sleep 2
		service_status api_server.js
		;;
  status)
		service_status api_server.js
		;;
    *)
	usage
		;;
esac
